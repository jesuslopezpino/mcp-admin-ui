<div class="assistant-container">
  <div class="header">
    <h2>ü§ñ MCP Assistant</h2>
    <p>Planifica y ejecuta tareas usando herramientas MCP</p>
  </div>

  <div class="form-section">
    <div class="form-group">
      <label for="message">Mensaje *</label>
      <textarea 
        id="message"
        [(ngModel)]="message" 
        placeholder="Describe la tarea que quieres realizar..."
        rows="4"
        [disabled]="isLoading"></textarea>
    </div>

    <div class="form-group">
      <label for="assetId">Asset ID (opcional)</label>
      <input 
        id="assetId"
        type="text" 
        [(ngModel)]="assetId" 
        placeholder="ID del asset relacionado"
        [disabled]="isLoading">
    </div>

    <div class="form-group">
      <label class="checkbox-label">
        <input 
          type="checkbox" 
          [(ngModel)]="useManualSelection"
          (change)="toggleManualSelection()"
          [disabled]="isLoading">
        <span>Selecci√≥n manual de herramienta</span>
      </label>
    </div>

    <div class="form-group" *ngIf="useManualSelection">
      <label for="selectedTool">Herramienta *</label>
      <select 
        id="selectedTool"
        [(ngModel)]="selectedTool"
        (change)="onToolSelected()"
        [disabled]="isLoading">
        <option value="">Selecciona una herramienta...</option>
        <option *ngFor="let tool of availableTools" [value]="tool.name">
          {{ tool.name }} - {{ tool.description }}
        </option>
      </select>
    </div>

    <!-- Dynamic Parameters Form -->
    <div class="parameters-section" *ngIf="useManualSelection && selectedTool && parameterDefinitions.length > 0">
      <h4>üìù Par√°metros de la Herramienta</h4>
      <div class="parameters-form">
        <div class="parameter-group" *ngFor="let param of parameterDefinitions">
          <label [for]="param.name">
            {{ param.label }}
            <span class="required" *ngIf="param.required">*</span>
          </label>
          
          <!-- Text Input -->
          <input 
            *ngIf="param.type === 'text'"
            [id]="param.name"
            type="text"
            [(ngModel)]="toolParameters[param.name]"
            [placeholder]="param.placeholder || ''"
            [disabled]="isLoading"
            class="parameter-input">
          
          <!-- Number Input -->
          <input 
            *ngIf="param.type === 'number'"
            [id]="param.name"
            type="number"
            [(ngModel)]="toolParameters[param.name]"
            [placeholder]="param.placeholder || ''"
            [disabled]="isLoading"
            class="parameter-input">
          
          <!-- Select Input -->
          <select 
            *ngIf="param.type === 'select'"
            [id]="param.name"
            [(ngModel)]="toolParameters[param.name]"
            [disabled]="isLoading"
            class="parameter-input">
            <option value="">{{ param.placeholder || 'Selecciona...' }}</option>
            <option *ngFor="let option of param.options" [value]="option">
              {{ option }}
            </option>
          </select>
          
          <!-- Checkbox Input -->
          <label class="checkbox-label" *ngIf="param.type === 'checkbox'">
            <input 
              [id]="param.name"
              type="checkbox"
              [(ngModel)]="toolParameters[param.name]"
              [disabled]="isLoading">
            <span>{{ param.label }}</span>
          </label>
        </div>
      </div>
    </div>

    <div class="actions">
      <button 
        class="btn btn-primary" 
        (click)="onPlan()" 
        [disabled]="isLoading || !message.trim() || (useManualSelection && (!selectedTool || !isParameterValid()))">
        <span *ngIf="isLoading">‚è≥</span>
        <span *ngIf="!isLoading">üìã</span>
        {{ isLoading ? 'Planificando...' : 'Planificar' }}
      </button>
      
      <button 
        class="btn btn-secondary" 
        (click)="onReset()" 
        [disabled]="isLoading">
        üîÑ Limpiar
      </button>
    </div>
  </div>

  <div class="error-message" *ngIf="error">
    <div class="error-content">
      <span class="error-icon">‚ö†Ô∏è</span>
      {{ error }}
    </div>
  </div>

  <div class="plan-section" *ngIf="plan">
    <h3>üìã Plan Generado</h3>
    <div class="plan-card">
      <div class="plan-header">
        <span class="tool-name">{{ plan.toolName }}</span>
        <span class="risk-score" [class]="'risk-' + (plan.riskScore > 7 ? 'high' : plan.riskScore > 4 ? 'medium' : 'low')">
          Riesgo: {{ plan.riskScore }}/10
        </span>
      </div>
      
      <div class="plan-details">
        <p><strong>Razonamiento:</strong> {{ plan.rationale }}</p>
        <p><strong>Requiere confirmaci√≥n:</strong> 
          <span [class]="plan.requiresConfirmation ? 'requires-confirmation' : 'no-confirmation'">
            {{ plan.requiresConfirmation ? 'S√≠' : 'No' }}
          </span>
        </p>
        <p><strong>Asset ID:</strong> {{ plan.assetId || 'N/A' }}</p>
      </div>

      <div class="plan-actions" *ngIf="plan.requiresConfirmation">
        <button 
          class="btn btn-success" 
          (click)="onExecute()" 
          [disabled]="isLoading">
          <span *ngIf="isLoading">‚è≥</span>
          <span *ngIf="!isLoading">‚úÖ</span>
          {{ isLoading ? 'Ejecutando...' : 'Confirmar y ejecutar' }}
        </button>
      </div>
    </div>
  </div>

  <div class="execution-section" *ngIf="executionResult">
    <h3>‚ö° Resultado de Ejecuci√≥n</h3>
    <div class="execution-card">
      <div class="execution-header">
        <span class="execution-id">ID: {{ executionResult.executionId }}</span>
        <span class="execution-status" [class]="'status-' + executionResult.status.toLowerCase()" [style.color]="getStatusColor(executionResult.status)">
          {{ getStatusIcon(executionResult.status) }} {{ executionResult.status }}
        </span>
        <span class="exit-code" [class]="executionResult.exitCode === 0 ? 'success' : 'failure'">
          Exit Code: {{ executionResult.exitCode }}
        </span>
      </div>
      
      <div class="execution-details">
        <div class="output-section" *ngIf="executionResult.stdout">
          <h4>üì§ Salida (STDOUT)</h4>
          <pre class="output-content">{{ getTruncatedStdout(executionResult.stdout) }}</pre>
          <button class="btn btn-small" *ngIf="executionResult.stdout.length > 200" (click)="showFullOutput = !showFullOutput">
            {{ showFullOutput ? 'Mostrar menos' : 'Mostrar completo' }}
          </button>
          <pre class="output-content" *ngIf="showFullOutput">{{ executionResult.stdout }}</pre>
        </div>
        
        <div class="error-section" *ngIf="executionResult.stderr">
          <h4>‚ùå Errores (STDERR)</h4>
          <pre class="error-content">{{ executionResult.stderr }}</pre>
        </div>
        
        <div class="info-section" *ngIf="!executionResult.stdout && !executionResult.stderr">
          <p class="info-message">
            <span [class]="executionResult.status === 'SUCCESS' ? 'success' : 'warning'">
              {{ executionResult.status === 'SUCCESS' ? '‚úÖ Ejecuci√≥n completada sin salida' : '‚ö†Ô∏è Ejecuci√≥n fall√≥ sin mensajes de error' }}
            </span>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="confirmation-overlay" *ngIf="showConfirmation">
    <div class="confirmation-modal">
      <h3>‚ö†Ô∏è Confirmaci√≥n Requerida</h3>
      <p>Esta herramienta puede realizar cambios en el sistema. ¬øEst√°s seguro de que quieres continuar?</p>
      <div class="confirmation-actions">
        <button class="btn btn-secondary" (click)="onCancelExecution()">
          Cancelar
        </button>
        <button class="btn btn-danger" (click)="onConfirmExecution()">
          ‚úÖ Confirmar y Ejecutar
        </button>
      </div>
    </div>
  </div>
</div>
