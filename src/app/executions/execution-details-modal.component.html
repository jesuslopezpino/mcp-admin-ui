<!-- Modal Backdrop -->
<div class="modal-backdrop" (click)="onClose()" data-testid="execution-details-backdrop">
  <div class="modal-container" (click)="$event.stopPropagation()" data-testid="execution-details-modal">

    <!-- Modal Header -->
    <div class="modal-header">
      <h3 class="modal-title">
        <span class="modal-icon">üìã</span>
        Detalles de Ejecuci√≥n
      </h3>
      <button class="close-btn" (click)="onClose()" data-testid="execution-details-close">
        ‚úï
      </button>
    </div>

    <!-- Modal Content -->
    <div class="modal-content">

      <!-- Loading State -->
      @if (loading) {
        <div class="loading-state" data-testid="execution-details-loading">
          <div class="loading-spinner">
            <span class="spinner-icon">‚è≥</span>
            <span class="loading-text">Cargando detalles de la ejecuci√≥n...</span>
          </div>
        </div>
      }

      <!-- Error State -->
      @if (error) {
        <div class="error-state" data-testid="execution-details-error">
          <div class="error-content">
            <span class="error-icon">‚ö†Ô∏è</span>
            <span class="error-message">{{ error }}</span>
            @if (executionId) {
              <button class="btn btn-sm btn-secondary" (click)="onReload()">
                üîÑ Reintentar
              </button>
            }
          </div>
        </div>
      }

      <!-- Execution Details -->
      @if (execution && !loading) {
        <div class="execution-details">
          <!-- Result Header -->
          <div class="result-header">
            <h4 class="result-title">
              <span class="exec-status"
                [class.exec-status--success]="execution.status === 'SUCCESS'"
                [class.exec-status--failed]="execution.status === 'FAILED'"
                [class.exec-status--error]="execution.status === 'ERROR'"
                data-testid="execution-details-status">
                {{ getStatusIcon(execution.status) }} {{ execution.status }}
              </span>
              @if (execution.id) {
                <span class="execution-id">ID: {{ execution.id.substring(0, 8) }}...</span>
              }
            </h4>
            <!-- Exit Code and Duration -->
            @if (execution.exitCode !== undefined || formatDuration(execution.startedAt, execution.finishedAt)) {
              <div class="result-meta">
                @if (execution.exitCode !== undefined) {
                  <span
                    class="exit-code"
                    data-testid="execution-details-exitcode">
                    Exit Code: {{ execution.exitCode }}
                  </span>
                }
                @if (formatDuration(execution.startedAt, execution.finishedAt)) {
                  <span
                    class="duration"
                    data-testid="execution-details-duration">
                    Duraci√≥n: {{ formatDuration(execution.startedAt, execution.finishedAt) }}
                  </span>
                }
              </div>
            }
          </div>
          <!-- Execution Info -->
          <div class="execution-info">
            <div class="info-grid">
              @if (execution.toolName) {
                <div class="info-item">
                  <span class="info-label">Herramienta:</span>
                  <span class="info-value">{{ execution.toolName }}</span>
                </div>
              }
              @if (execution.startedAt) {
                <div class="info-item">
                  <span class="info-label">Iniciado:</span>
                  <span class="info-value">{{ execution.startedAt | date:'medium' }}</span>
                </div>
              }
              @if (execution.finishedAt) {
                <div class="info-item">
                  <span class="info-label">Finalizado:</span>
                  <span class="info-value">{{ execution.finishedAt | date:'medium' }}</span>
                </div>
              }
            </div>
          </div>
          <!-- Error Details -->
          @if ((execution.status === 'FAILED' || execution.status === 'ERROR') && (execution.errorCode || execution.failureStage)) {
            <div class="exec-error__section"
              >
              <h5>üîç Detalles del Error</h5>
              <div class="error-details">
                @if (execution.failureStage) {
                  <div class="error-item">
                    <span class="error-label">Etapa:</span>
                    <span class="failure-stage" data-testid="execution-details-failure-stage">{{ execution.failureStage }}</span>
                  </div>
                }
                @if (execution.errorCode) {
                  <div class="error-item">
                    <span class="error-label">C√≥digo:</span>
                    <span class="error-code" data-testid="execution-details-error-code">{{ execution.errorCode }}</span>
                  </div>
                }
                @if (execution.errorReason) {
                  <div class="error-item">
                    <span class="error-label">Motivo:</span>
                    <span class="error-reason">{{ execution.errorReason }}</span>
                  </div>
                }
              </div>
            </div>
          }
          <!-- JSON Response Block -->
          @if (execution.responseJson) {
            <div class="exec-json__section" data-testid="execution-details-json">
              <h5>üìÑ Respuesta JSON</h5>
              <div class="json-container">
                <pre class="json-content">{{ getPrettyJson(execution.responseJson) }}</pre>
                <div class="json-actions">
                  <button class="btn btn-sm btn-secondary"
                    (click)="copyJson(execution.responseJson)"
                    data-testid="execution-details-json-copy">
                    üìã Copiar JSON
                  </button>
                  <button class="btn btn-sm btn-secondary"
                    (click)="downloadJson(execution.responseJson)"
                    data-testid="execution-details-json-download">
                    üíæ Descargar JSON
                  </button>
                </div>
              </div>
            </div>
          }
          <!-- Terminal Output -->
          <div class="terminal-block">
            <app-terminal-output
              [stdout]="execution.stdout || ''"
              [stderr]="execution.stderr || ''"
              [exitCode]="execution.exitCode || 0"
              [status]="execution.status"
              [targetHostname]="getSelectedAsset()?.hostname || ''"
              [targetIp]="getSelectedAsset()?.ip || ''"
              [commandName]="execution.toolName || ''"
              [executionId]="execution.id">
            </app-terminal-output>
          </div>
        </div>
      }
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="onClose()" data-testid="execution-details-close-btn">
        Cerrar
      </button>
    </div>
  </div>
</div>
