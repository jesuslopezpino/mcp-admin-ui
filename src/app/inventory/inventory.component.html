<div class="inventory-container">
  <!-- Header Section -->
  <div class="header" data-testid="inventory-header">
    <h2>üîç Inventario de Equipos</h2>
    <p>Descubre y gestiona equipos en tu red</p>
  </div>

  <!-- Actions Bar -->
  <div class="actions-bar" data-testid="actions-bar">
    <div class="search-filters" data-testid="search-filters">
      <input
        type="text"
        class="search-input"
        placeholder="üîç Buscar por hostname o IP..."
        [(ngModel)]="searchTerm"
        (input)="filterAssets()"
        data-testid="search-input">

        <select class="filter-select" [(ngModel)]="statusFilter" (change)="filterAssets()" data-testid="status-filter">
          <option value="">Todos los estados</option>
          <option value="online">üü¢ Online</option>
          <option value="offline">üî¥ Offline</option>
          <option value="unknown">üü° Desconocido</option>
        </select>

        <select class="filter-select" [(ngModel)]="osFilter" (change)="filterAssets()" data-testid="os-filter">
          <option value="">Todos los OS</option>
          <option value="windows">ü™ü Windows</option>
          <option value="linux">üêß Linux</option>
          <option value="macos">üçé macOS</option>
        </select>
      </div>

      <div class="action-buttons" data-testid="action-buttons">
        <button
          class="btn btn-primary"
          (click)="discoverAssets()"
          [disabled]="isDiscovering"
          data-testid="discover-button">
          @if (isDiscovering) {
            <span>‚è≥</span>
          }
          @if (!isDiscovering) {
            <span>üîç</span>
          }
          {{ isDiscovering ? 'Escaneando...' : 'Descubrir ahora' }}
        </button>

        <button
          class="btn btn-secondary"
          (click)="loadAssets()"
          [disabled]="isLoading"
          data-testid="refresh-button">
          @if (isLoading) {
            <span>‚è≥</span>
          }
          @if (!isLoading) {
            <span>üîÑ</span>
          }
          {{ isLoading ? 'Cargando...' : 'Actualizar' }}
        </button>
      </div>
    </div>

    <!-- Progress Indicator -->
    @if (isDiscovering) {
      <div class="progress-card">
        <div class="progress-content">
          <div class="progress-info">
            <h4>üîç Escaneando red...</h4>
            <p>Descubriendo equipos en la red local</p>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="scanProgress"></div>
            </div>
            <span class="progress-text">{{ scanProgress.toFixed(0) }}%</span>
          </div>
        </div>
      </div>
    }

    <!-- Discovery Results -->
    @if (discoveryResult) {
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üñ•Ô∏è</div>
          <div class="stat-content">
            <h3>{{ discoveryResult.countOnline }}</h3>
            <p>Equipos Encontrados</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚öôÔ∏è</div>
          <div class="stat-content">
            <h3>{{ discoveryResult.countWinRm }}</h3>
            <p>Con WinRM</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚è±Ô∏è</div>
          <div class="stat-content">
            <h3>{{ formatDuration(discoveryResult.durationMs) }}</h3>
            <p>Duraci√≥n</p>
          </div>
        </div>
      </div>
    }

    <!-- Error Message -->
    @if (errorMessage) {
      <div class="error-message">
        <div class="error-content">
          <span class="error-icon">‚ö†Ô∏è</span>
          {{ errorMessage }}
        </div>
      </div>
    }

    <!-- Bulk Actions -->
    @if (filteredAssets.length > 0) {
      <div class="bulk-actions">
        <div class="bulk-info">
          <label class="checkbox-label">
            <input
              type="checkbox"
              [(ngModel)]="selectAll"
              (change)="toggleSelectAll()">
              <span>Seleccionar todos ({{ selectedAssets.length }}/{{ filteredAssets.length }})</span>
            </label>
          </div>
          @if (selectedAssets.length > 0) {
            <div class="bulk-buttons">
              <button class="btn btn-outline" (click)="executeBulkAction('ping')">
                üì° Ping Masivo
              </button>
              <button class="btn btn-outline" (click)="executeBulkAction('info')">
                ‚ÑπÔ∏è Info Masiva
              </button>
              <button class="btn btn-outline" (click)="exportSelected()">
                üì• Exportar
              </button>
            </div>
          }
        </div>
      }

      <!-- Assets Grid -->
      @if (filteredAssets.length > 0) {
        <div class="assets-grid">
          @for (asset of paginatedAssets; track asset) {
            <div class="asset-card"
              [class.selected]="selectedAssets.includes(asset.id)"
              [attr.data-testid]="'asset-card-' + asset.id">
              <div class="asset-header">
                <div class="asset-info">
                  <h3 class="asset-name">
                    <span class="asset-icon">üñ•Ô∏è</span>
                    {{ asset.hostname }}
                  </h3>
                  <p class="asset-ip">{{ asset.ip }}</p>
                </div>
                <div class="asset-status">
                  <span class="status-badge"
                    [class]="'status-' + asset.status">
                    <span class="status-dot"></span>
                    {{ asset.status }}
                  </span>
                </div>
              </div>
              <div class="asset-details">
                <div class="detail-row">
                  <span class="detail-label">Sistema Operativo:</span>
                  <span class="detail-value os-badge" [class]="'os-' + asset.os">
                    <span class="os-icon" [class]="'icon-' + asset.os"></span>
                    {{ asset.os }}
                  </span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">WinRM:</span>
                  <span class="detail-value winrm-badge"
                    [class]="asset.winrmEnabled ? 'winrm-enabled' : 'winrm-disabled'">
                    <span class="winrm-icon">{{ asset.winrmEnabled ? '‚úÖ' : '‚ùå' }}</span>
                    {{ asset.winrmEnabled ? 'Habilitado' : 'Deshabilitado' }}
                  </span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">√öltima vez visto:</span>
                  <span class="detail-value">{{ formatDate(asset.lastSeen) }}</span>
                </div>
              </div>
              <div class="asset-actions">
                <div class="action-checkbox">
                  <input
                    type="checkbox"
                    [checked]="selectedAssets.includes(asset.id)"
                    (change)="toggleAssetSelection(asset.id)">
                  </div>
                  <div class="action-buttons" data-testid="asset-actions">
                    <button
                      class="btn btn-sm btn-outline"
                      (click)="viewAssetDetails(asset)"
                      [attr.data-testid]="'view-details-' + asset.id"
                      title="Ver detalles">
                      üëÅÔ∏è
                    </button>
                    <button
                      class="btn btn-sm btn-primary"
                      (click)="openRunToolModal(asset)"
                      [disabled]="asset.status !== 'online'"
                      [attr.data-testid]="'execute-tool-' + asset.id"
                      title="Ejecutar herramienta">
                      ‚ö°
                    </button>
                    <button
                      class="btn btn-sm btn-secondary"
                      (click)="pingAsset(asset)"
                      [attr.data-testid]="'ping-asset-' + asset.id"
                      title="Hacer ping">
                      üì°
                    </button>
                  </div>
                </div>
                <!-- Ping Result Display -->
                @if (asset.pingResult) {
                  <div class="ping-result">
                    <div class="ping-result-content" [class]="'ping-' + asset.pingResult.status">
                      <div class="ping-status">
                        <span class="ping-message">{{ asset.pingResult.message }}</span>
                        <span class="ping-time">{{ formatTime(asset.pingResult.timestamp) }}</span>
                      </div>
                      @if (asset.pingResult.details.stdout) {
                        <div class="ping-details">
                          <pre class="ping-output">{{ asset.pingResult.details.stdout }}</pre>
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        }

        <!-- Empty State -->
        @if (filteredAssets.length === 0 && !isLoading) {
          <div class="empty-state" data-testid="empty-state">
            <div class="empty-content">
              <span class="empty-icon">üîç</span>
              @if (searchTerm || statusFilter || osFilter) {
                <h3>No se encontraron equipos</h3>
              }
              @if (!searchTerm && !statusFilter && !osFilter) {
                <h3>No hay equipos descubiertos</h3>
              }
              @if (searchTerm || statusFilter || osFilter) {
                <p>
                  Intenta ajustar los filtros de b√∫squeda
                </p>
              }
              @if (!searchTerm && !statusFilter && !osFilter) {
                <p>
                  Haz clic en "Descubrir ahora" para escanear la red
                </p>
              }
              @if (!searchTerm && !statusFilter && !osFilter) {
                <button
                  class="btn btn-primary"
                  (click)="discoverAssets()">
                  üîç Descubrir Equipos
                </button>
              }
            </div>
          </div>
        }

        <!-- Loading State -->
        @if (isLoading && filteredAssets.length === 0) {
          <div class="loading-state">
            <div class="loading-content">
              <span class="loading-icon">‚è≥</span>
              Cargando equipos...
            </div>
          </div>
        }

        <!-- Pagination -->
        @if (filteredAssets.length > itemsPerPage) {
          <div class="pagination">
            <div class="pagination-info">
              Mostrando {{ (currentPage - 1) * itemsPerPage + 1 }} - {{ Math.min(currentPage * itemsPerPage, filteredAssets.length) }}
              de {{ filteredAssets.length }} equipos
            </div>
            <div class="pagination-controls">
              <button
                class="btn btn-sm"
                [disabled]="currentPage === 1"
                (click)="setPage(currentPage - 1)">
                ‚Üê Anterior
              </button>
              <span class="page-info">
                P√°gina {{ currentPage }} de {{ totalPages }}
              </span>
              <button
                class="btn btn-sm"
                [disabled]="currentPage === totalPages"
                (click)="setPage(currentPage + 1)">
                Siguiente ‚Üí
              </button>
            </div>
          </div>
        }

        <!-- Asset Details Modal -->
        @if (showAssetDetailsModal) {
          <div class="modal-overlay" (click)="closeAssetDetailsModal()">
            <div class="modal-content" (click)="$event.stopPropagation()">
              <div class="modal-header">
                <h3>üñ•Ô∏è Detalles del Equipo</h3>
                <button class="modal-close" (click)="closeAssetDetailsModal()">√ó</button>
              </div>
              @if (selectedAssetDetails) {
                <div class="modal-body">
                  <div class="modal-grid">
                    <div class="modal-section">
                      <h4>üìã Informaci√≥n B√°sica</h4>
                      <div class="info-grid">
                        <div class="info-item">
                          <span class="info-label">Hostname:</span>
                          <span class="info-value">{{ selectedAssetDetails.hostname }}</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">IP:</span>
                          <span class="info-value code">{{ selectedAssetDetails.ip }}</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Sistema Operativo:</span>
                          <span class="info-value">{{ selectedAssetDetails.os }}</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Estado:</span>
                          <span class="info-value status-badge" [class]="'status-' + selectedAssetDetails.status">
                            {{ selectedAssetDetails.status }}
                          </span>
                        </div>
                      </div>
                    </div>
                    <div class="modal-section">
                      <h4>‚öôÔ∏è Configuraci√≥n</h4>
                      <div class="info-grid">
                        <div class="info-item">
                          <span class="info-label">WinRM:</span>
                          <span class="info-value winrm-badge"
                            [class]="selectedAssetDetails.winrmEnabled ? 'winrm-enabled' : 'winrm-disabled'">
                            {{ selectedAssetDetails.winrmEnabled ? 'Habilitado' : 'Deshabilitado' }}
                          </span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">√öltima vez visto:</span>
                          <span class="info-value">{{ formatDate(selectedAssetDetails.lastSeen) }}</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">ID del Asset:</span>
                          <span class="info-value code">{{ selectedAssetDetails.id }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              }
              <div class="modal-footer">
                <button class="btn btn-secondary" (click)="closeAssetDetailsModal()">
                  Cerrar
                </button>
                <button class="btn btn-primary" (click)="openRunToolModal(selectedAssetDetails!)">
                  ‚ö° Ejecutar Herramienta
                </button>
              </div>
            </div>
          </div>
        }

        <!-- Run Tool Modal -->
        @if (showRunToolModal) {
          <app-run-tool-modal
            [tool]="selectedTool"
            [assetId]="selectedAsset?.id || ''"
            [destinationLabel]="selectedAsset ? (selectedAsset.hostname + ' (' + selectedAsset.ip + ')') : ''"
            (close)="closeRunToolModal()"
            (result)="executeTool($event)">
          </app-run-tool-modal>
        }
      </div>
