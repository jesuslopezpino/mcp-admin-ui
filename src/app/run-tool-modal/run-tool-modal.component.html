<div class="modal-overlay" (click)="onClose()" data-testid="run-tool-modal-overlay">
  <div class="modal-content" (click)="$event.stopPropagation()" data-testid="run-tool-modal">
    <div class="modal-header" data-testid="run-modal-title">
      <h2>üîß Ejecutar Herramienta</h2>
      <div class="destination-info" data-testid="destination-info">
        <span class="destination-label">Destino:</span>
        <span class="destination-value">{{ getDestinationDisplay() }}</span>
      </div>

      <!-- Status indicator during execution -->
      @if (isExecuting || executionResult) {
        <div class="status-indicator" data-testid="execution-status">
          <span class="status-icon">{{ getStatusIcon(currentStatus || 'PENDING') }}</span>
          <span class="status-text">{{ currentStatus || 'PENDING' }}</span>
          @if (isExecuting) {
            <span class="spinner">‚è≥</span>
          }
        </div>
      }

      <button class="close-btn" (click)="onClose()" data-testid="close-modal" [disabled]="isExecuting">√ó</button>
    </div>

    @if (tool) {
      <div class="modal-body" data-testid="modal-body">
        <div class="tool-info" data-testid="tool-info">
          <h3>{{ tool.name }}</h3>
          <p>{{ tool.description }}</p>
          <div class="tool-meta">
            <span class="meta-item" [class.requires-confirmation]="tool.requiresConfirmation">
              {{ tool.requiresConfirmation ? '‚ö†Ô∏è Requiere confirmaci√≥n' : '‚úÖ Ejecuci√≥n directa' }}
            </span>
            <span class="meta-item">OS: {{ tool.osSupport.join(', ') || 'N/A' }}</span>
          </div>
        </div>
        <!-- Target Selection -->
        @if (isTargetRequired) {
          <div class="target-selection">
            <h4>üéØ Destino de Ejecuci√≥n</h4>
            <p class="target-description">Selecciona el equipo donde ejecutar la herramienta</p>
            <app-target-selector
              [assets]="assets"
              [selectedAssetId]="selectedAssetId"
              (selectedAssetIdChange)="onTargetSelected($event)">
            </app-target-selector>
            @if (!isTargetValid()) {
              <div class="target-validation">
                <span class="validation-error">‚ö†Ô∏è Debes seleccionar un destino para continuar</span>
              </div>
            }
          </div>
        }
        <form [formGroup]="form" (ngSubmit)="onSubmit()" class="tool-form">
          @if (tool.jsonSchema?.properties) {
            <div class="form-fields">
              @for (fieldName of getFieldNames(); track fieldName) {
                <div class="form-field">
                  <label [for]="fieldName" [class.required]="getFieldRequired(fieldName)">
                    {{ getFieldLabel(fieldName) }}
                    @if (getFieldRequired(fieldName)) {
                      <span class="required-mark">*</span>
                    }
                  </label>
                  <!-- Regular string input -->
                  @if (getFieldType(tool.jsonSchema.properties[fieldName]) === 'text') {
                    <input
                      type="text"
                      [id]="fieldName"
                      [formControlName]="fieldName"
                      [placeholder]="getFieldPlaceholder(tool.jsonSchema.properties[fieldName])"
                      class="form-input"
                      [class.error]="form.get(fieldName)?.invalid && form.get(fieldName)?.touched"
                      [attr.data-testid]="'input-' + fieldName">
                  }
                  <!-- Number input -->
                  @if (getFieldType(tool.jsonSchema.properties[fieldName]) === 'number') {
                    <input
                      type="number"
                      [id]="fieldName"
                      [formControlName]="fieldName"
                      [min]="getFieldMin(tool.jsonSchema.properties[fieldName])"
                      [max]="getFieldMax(tool.jsonSchema.properties[fieldName])"
                      class="form-input"
                      [class.error]="form.get(fieldName)?.invalid && form.get(fieldName)?.touched"
                      [attr.data-testid]="'input-' + fieldName">
                  }
                  <!-- Boolean input -->
                  @if (getFieldType(tool.jsonSchema.properties[fieldName]) === 'checkbox') {
                    <label
                      class="checkbox-label">
                      <input type="checkbox"
                        [id]="fieldName"
                        [formControlName]="fieldName"
                        [attr.data-testid]="'input-' + fieldName">
                        <span class="checkbox-text">{{ getFieldPlaceholder(tool.jsonSchema.properties[fieldName]) }}</span>
                      </label>
                    }
                    <!-- Select input -->
                    @if (getFieldType(tool.jsonSchema.properties[fieldName]) === 'select') {
                      <select
                        [id]="fieldName"
                        [formControlName]="fieldName"
                        class="form-select"
                        [class.error]="form.get(fieldName)?.invalid && form.get(fieldName)?.touched"
                        [attr.data-testid]="'input-' + fieldName">
                        <option value="">{{ getFieldPlaceholder(tool.jsonSchema.properties[fieldName]) }}</option>
                        @for (option of getFieldOptions(tool.jsonSchema.properties[fieldName]); track option) {
                          <option
                            [value]="option">
                            {{ option }}
                          </option>
                        }
                      </select>
                    }
                    <!-- Error message -->
                    @if (form.get(fieldName)?.invalid && form.get(fieldName)?.touched) {
                      <div
                        class="error-message">
                        @if (form.get(fieldName)?.errors?.['required']) {
                          <span>Campo obligatorio</span>
                        }
                        @if (form.get(fieldName)?.errors?.['minLength']) {
                          <span>Longitud m√≠nima no alcanzada</span>
                        }
                        @if (form.get(fieldName)?.errors?.['maxLength']) {
                          <span>Longitud m√°xima excedida</span>
                        }
                      </div>
                    }
                  </div>
                }
              </div>
            }
            <div class="form-actions">
              <button type="button"
                class="btn btn-secondary"
                (click)="onClose()"
                [disabled]="isExecuting"
                data-testid="cancel-button">
                {{ isExecuting ? 'Cerrar' : 'Cancelar' }}
              </button>
              <button type="button"
                class="btn btn-info"
                (click)="onPreview()"
                [disabled]="form.invalid || isExecuting || (isTargetRequired && !isTargetValid())"
                data-testid="preview-button">
                üëÅÔ∏è Previsualizar
              </button>
              <button type="submit"
                class="btn btn-primary"
                [disabled]="form.invalid || isExecuting || (isTargetRequired && !isTargetValid())"
                data-testid="run-modal-submit">
                @if (isExecuting) {
                  <span class="spinner-icon">‚è≥</span>
                }
                @if (!isExecuting) {
                  <span>üöÄ</span>
                }
                {{ isExecuting ? 'Ejecutando...' : 'Ejecutar' }}
              </button>
            </div>
          </form>
          <!-- Preview Command Section -->
          @if (showPreview) {
            <div class="preview-section">
              <div class="preview-header">
                <h4>üëÅÔ∏è Previsualizaci√≥n del Comando</h4>
                <button class="btn btn-secondary btn-sm" (click)="onClosePreview()">
                  ‚úï Cerrar
                </button>
              </div>
              <app-terminal-output
                [stdout]="previewCommand"
                [stderr]="''"
                [exitCode]="0"
                [status]="'PREVIEW'"
                [targetHostname]="getSelectedAsset()?.hostname || ''"
                [targetIp]="getSelectedAsset()?.ip || ''"
                [commandName]="tool.name || ''">
              </app-terminal-output>
            </div>
          }
          <!-- Execution Result with Enhanced Error Display -->
          @if (executionResult !== null) {
            <div class="execution-result" data-testid="run-modal-result">
              <!-- Result Header -->
              <div class="result-header">
                <h4 class="result-title">
                  <span class="exec-status"
                    [class.exec-status--success]="executionResult.status === 'SUCCESS'"
                    [class.exec-status--failed]="executionResult.status === 'FAILED'"
                    [class.exec-status--error]="executionResult.status === 'ERROR'"
                    data-testid="run-modal-result-status">
                    {{ getStatusIcon(executionResult.status) }} {{ executionResult.status }}
                  </span>
                  @if (executionId) {
                    <span class="execution-id">ID: {{ executionId.substring(0, 8) }}...</span>
                  }
                </h4>
                <!-- Exit Code and Duration -->
                @if (executionResult.exitCode !== undefined || getExecutionDuration()) {
                  <div class="result-meta">
                    @if (executionResult.exitCode !== undefined) {
                      <span
                        class="exit-code"
                        data-testid="run-modal-result-exitcode">
                        Exit Code: {{ executionResult.exitCode }}
                      </span>
                    }
                    @if (getExecutionDuration()) {
                      <span
                        class="duration"
                        data-testid="run-modal-result-duration">
                        Duraci√≥n: {{ getExecutionDuration() }}
                      </span>
                    }
                  </div>
                }
              </div>
              <!-- Error Details (only for FAILED or ERROR) -->
              @if ((executionResult.status === 'FAILED' || executionResult.status === 'ERROR') && (executionResult.errorCode || executionResult.failureStage)) {
                <div class="exec-error__section"
                  >
                  <h5>üîç Detalles del Error</h5>
                  <div class="error-details">
                    @if (executionResult.failureStage) {
                      <div class="error-item">
                        <span class="error-label">Etapa:</span>
                        <span class="failure-stage" data-testid="run-modal-failure-stage">{{ executionResult.failureStage }}</span>
                      </div>
                    }
                    @if (executionResult.errorCode) {
                      <div class="error-item">
                        <span class="error-label">C√≥digo:</span>
                        <span class="error-code" data-testid="run-modal-error-code">{{ executionResult.errorCode }}</span>
                      </div>
                    }
                    @if (executionResult.errorReason) {
                      <div class="error-item">
                        <span class="error-label">Motivo:</span>
                        <span class="error-reason" data-testid="run-modal-error-reason">{{ executionResult.errorReason }}</span>
                      </div>
                    }
                  </div>
                </div>
              }
              <!-- JSON Response Block (only if responseJson exists) -->
              @if (executionResult.responseJson) {
                <div class="exec-json__section" data-testid="run-modal-response-json">
                  <h5>üìÑ Respuesta JSON</h5>
                  <div class="json-container">
                    <pre class="json-content">{{ getPrettyJson(executionResult.responseJson) }}</pre>
                    <div class="json-actions">
                      <button class="btn btn-sm btn-secondary"
                        (click)="copyJson(executionResult.responseJson)"
                        data-testid="run-modal-response-json-copy">
                        üìã Copiar JSON
                      </button>
                      <button class="btn btn-sm btn-secondary"
                        (click)="downloadJson(executionResult.responseJson, executionId)"
                        data-testid="run-modal-response-json-download">
                        üíæ Descargar JSON
                      </button>
                    </div>
                  </div>
                </div>
              }
              <!-- Terminal Output -->
              <div class="terminal-block">
                <app-terminal-output
                  [stdout]="executionResult.stdout || ''"
                  [stderr]="executionResult.stderr || ''"
                  [exitCode]="executionResult.exitCode || 0"
                  [status]="executionResult.status"
                  [targetHostname]="getSelectedAsset()?.hostname || ''"
                  [targetIp]="getSelectedAsset()?.ip || ''"
                  [commandName]="tool.name || ''"
                  [executionId]="executionId || undefined">
                </app-terminal-output>
              </div>
            </div>
          }
        </div>
      }

      <!-- Confirmation Dialog -->
      @if (showConfirmationDialog) {
        <div class="confirmation-overlay" data-testid="run-modal-confirm">
          <div class="confirmation-modal">
            <h3>‚ö†Ô∏è Confirmaci√≥n Requerida</h3>
            <p>Esta herramienta requiere confirmaci√≥n. ¬øEst√°s seguro de que quieres ejecutar <strong>{{ tool?.name }}</strong>?</p>
            <p class="confirmation-warning">Esta acci√≥n puede realizar cambios en el sistema.</p>
            <div class="confirmation-actions">
              <button class="btn btn-secondary"
                (click)="onCancelConfirmation()"
                data-testid="confirm-cancel">
                Cancelar
              </button>
              <button class="btn btn-danger"
                (click)="onConfirm()"
                data-testid="confirm-execute">
                ‚úÖ Confirmar y Ejecutar
              </button>
            </div>
          </div>
        </div>
      }
    </div>
  </div>
