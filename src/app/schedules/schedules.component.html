<div class="schedules-container">
  <div class="schedules-header">
    <h1>Tareas programadas</h1>
    <button
      class="btn btn-primary"
      (click)="openNewModal()"
      data-testid="schedule-new">
      New Schedule
    </button>
  </div>

  <div class="schedules-content">
    @if (loading) {
      <div class="loading">
        <div class="spinner"></div>
        <p>Loading scheduled tasks...</p>
      </div>
    }

    @if (!loading) {
      <div class="schedules-table-container">
        <table class="schedules-table" data-testid="schedules-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Tool</th>
              <th>Destino</th>
              <th>Cron</th>
              <th>Enabled</th>
              <th>Next Run</th>
              <th>Last Run</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (task of schedules; track trackByTaskId($index, task)) {
              <tr>
                <td class="task-name">{{ task.name }}</td>
                <td class="task-tool">{{ getToolName(task) }}</td>
                <td class="task-destination">{{ getDestinationLabel(task) }}</td>
                <td class="task-cron">{{ task.cronExpr }}</td>
                <td class="task-enabled">
                  <span
                    class="badge"
                    [class.badge-success]="task.enabled"
                    [class.badge-danger]="!task.enabled">
                    {{ task.enabled ? 'Enabled' : 'Disabled' }}
                  </span>
                </td>
                <td class="task-next-run">{{ formatDate(task.nextRunAt) }}</td>
                <td class="task-last-run">{{ formatDate(task.lastRunAt) }}</td>
                <td class="task-actions">
                  <button
                    class="btn btn-sm btn-success"
                    (click)="runTaskNow(task)"
                    [disabled]="isActionInProgress(task.id)"
                    [attr.data-testid]="'schedule-run-now-' + task.id"
                    title="Execute immediately">
                    ▶ Run Now
                  </button>
                  @if (task.enabled) {
                    <button
                      class="btn btn-sm btn-warning"
                      (click)="pauseTask(task)"
                      [disabled]="isActionInProgress(task.id)"
                      [attr.data-testid]="'schedule-pause-' + task.id"
                      title="Pause automatic execution">
                      ⏸ Pause
                    </button>
                  }
                  @if (!task.enabled) {
                    <button
                      class="btn btn-sm btn-info"
                      (click)="resumeTask(task)"
                      [disabled]="isActionInProgress(task.id)"
                      [attr.data-testid]="'schedule-resume-' + task.id"
                      title="Resume automatic execution">
                      ▶ Resume
                    </button>
                  }
                  <button
                    class="btn btn-sm btn-outline-primary"
                    (click)="openEditModal(task)"
                    [disabled]="isActionInProgress(task.id)"
                    data-testid="schedule-edit">
                    Edit
                  </button>
                  <button
                    class="btn btn-sm btn-outline-danger"
                    (click)="deleteTask(task)"
                    [disabled]="isActionInProgress(task.id)"
                    data-testid="schedule-delete">
                    Delete
                  </button>
                </td>
              </tr>
            }
            @if (schedules.length === 0) {
              <tr>
                <td colspan="8" class="no-tasks">
                  No scheduled tasks found. Create your first scheduled task!
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>

  <!-- Modal -->
  @if (showModal) {
    <app-schedule-modal
      [task]="editingTask"
      [tools]="tools"
      [assets]="assets"
      (saved)="onTaskSaved($event)"
      (closed)="closeModal()">
    </app-schedule-modal>
  }
</div>

